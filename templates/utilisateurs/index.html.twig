{% extends 'base.html.twig' %}
{% block title 'Utilisateurs' %}
{% block body %}
    {% if error is defined %}
        <h2>{{ error }}</h2>
    {% endif %}
    <form method="POST" action="{{ path('utilisateurs.add') }}">
        <select id="util_select" name="typeUtil">
            <option {% if select is defined and select == 'Eleves' %}selected{% endif %} value="Eleves">Eleves</option>
            <option {% if select is defined and select == 'Professeurs' %}selected{% endif %} value="Professeurs">
                Professeurs
            </option>
            <option {% if select is defined and select == 'Personnels' %}selected{% endif %} value="Personnels">
                Personnels
            </option>
        </select>

        <input type="submit" value="Ajouter">
        <select id="limit" name="limit">
            <option value="15">15</option>
            <option value="30">30</option>
            <option value="45">45</option>
        </select>
        <button type="button" id="offsetMoins"><</button>
        <button type="button" id="offsetPlus">></button>
        <input id="search" type="search" placeholder="Search" aria-label="Search">
    </form>
    <div class="modal fade" id="modalCRUD" tabindex="-1" role="dialog" aria-labelledby="modalCRUD" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitre"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <div id="ajax_results">

    </div>

{% endblock %}
{% block javascripts %}
    <script>
        let select = $('#util_select');
        let div = $('#ajax_results');
        let plus = $('#offsetPlus');
        let moins = $('#offsetMoins');
        let limit = $('#limit');
        let updateButton = $('.update');
        let deleteButton = $('.delete');
        let search_input = $('#search');
        let modal = $('#modalCRUD');
        let modalTitre = $("#modalTitre");
        let modalBody = $("#modal-body");

        let offset = 0;

        $(moins).click(function () {
            offset -= 1;
            if (offset < 0) {
                offset = 0;
            } else {
                AJAX();
            }
        })

        $(plus).click(function () {
            offset += 1;
            AJAX();
        })
        $(search_input).keyup(function () {
            AJAX()
        })
        $(select).change(function () {
            AJAX();
        })
        $(limit).change(function () {
            AJAX();
        })
        $(document).ready(function () {
            AJAX();
        })

        function AJAX() {
            let user = select.children('option:selected').val();

            $.ajax({
                url: "{{ path('utilisateurs.ajax') }}",
                method: "POST",
                data: {user: user, limit: limit.val(), offset: offset, search: search_input.val()}
            }).done(function (msg) {
                div.html(msg);
            })
        }

        modal.on('show.bs.modal', function (event) {
            let button = $(event.relatedTarget) // Button that triggered the modal
            let CRUD = button.data('button') // Extract info from data-* attributes
            let path = "";
            if (CRUD === "modif") {
                path = "{{ path('utilisateurs.modif') }}";
            } else if (CRUD === "suppr") {
                path = "{{ path('utilisateurs.delete') }}";
            }
            $.ajax({
                url: path,
                method: "POST",
                data: {user: button.data('user'), id: button.data('id')}
            }).done(function (msg) {
                modalTitre.text(msg.titre)
                modalBody.html(msg.form.content)
            })
        })
        modal.on('hide.bs.modal', function () {
            modalTitre.text("")
            modalBody.html("")
        })
    </script>
{% endblock %}